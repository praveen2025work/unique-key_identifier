<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Run #{{ run_id }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #337ab7 0%, #2c5f8d 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            padding: 8px;
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        h1 {
            font-size: 1.4em;
            margin-bottom: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 10px;
        }

        .run-header {
            background: #337ab7;
            color: white;
            padding: 12px 15px;
            border-radius: 4px 4px 0 0;
            margin: -15px -15px 15px -15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .run-header h2 {
            font-size: 1.2em;
            margin: 0;
        }

        .run-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .run-meta-item {
            background: rgba(255,255,255,0.15);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.85em;
        }

        .btn {
            background: #337ab7;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: #286090;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 3px 8px;
            font-size: 11px;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .group-nav {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        .group-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #337ab7;
            color: #337ab7;
            border-radius: 3px;
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .group-btn:hover {
            background: #337ab7;
            color: white;
        }

        .group-btn.active {
            background: #337ab7;
            color: white;
        }

        .group-badge {
            display: inline-block;
            background: #5cb85c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 4px;
        }

        .comparison-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .table-panel {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 12px;
            border: 1px solid #e0e0e0;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #337ab7;
        }

        .table-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #337ab7;
        }

        .table-badge {
            background: #337ab7;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            font-size: 12px;
        }

        .results-table th {
            background: #337ab7;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .results-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .results-table tr.unique-key {
            background: linear-gradient(to right, #ecfdf5 0%, white 100%);
        }

        .results-table tr.has-duplicates {
            background: linear-gradient(to right, #fffbeb 0%, white 100%);
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.unique {
            background: #5cb85c;
            color: white;
        }

        .status-badge.duplicate {
            background: #f0ad4e;
            color: white;
        }

        .score-bar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-bar-fill {
            flex: 1;
            height: 5px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .score-bar-value {
            height: 100%;
            transition: width 0.3s;
        }

        .score-bar-value.high {
            background: #5cb85c;
        }

        .score-bar-value.medium {
            background: #f0ad4e;
        }

        .score-bar-value.low {
            background: #d9534f;
        }

        .score-text {
            font-weight: 600;
            min-width: 40px;
            text-align: right;
            font-size: 11px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #337ab7;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1200px) {
            .comparison-tables {
                grid-template-columns: 1fr;
            }
        }

        .columns-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }

        .column-tag {
            background: #337ab7;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .column-tag:hover {
            background: #286090;
            transform: scale(1.05);
        }

        /* Removed old group-summary styles - now using inline compact design */

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e0e0e0;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div class="toast" id="toast">Copied to clipboard!</div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Loading Results...</div>
            <div class="loading-subtext">Please wait while we fetch your data</div>
        </div>
    </div>
    <div class="container">
        <header>
            <h1>üìä Analysis Results</h1>
            <p class="subtitle">Run #{{ run_id }} - Grouped by Combination Size</p>
        </header>

        <div class="card">
            <div class="run-header">
                <h2>Run #{{ run_id }} - {{ timestamp }}</h2>
                <div class="run-meta">
                    <div class="run-meta-item">
                        <strong>File A:</strong> {{ file_a }} ({{ file_a_rows }} rows)
                    </div>
                    <div class="run-meta-item">
                        <strong>File B:</strong> {{ file_b }} ({{ file_b_rows }} rows)
                    </div>
                    <div class="run-meta-item">
                        <strong>Columns:</strong> {{ columns|length }} total
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <div>
                    <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                    <a href="/workflow/{{ run_id }}" class="btn btn-secondary">üîÑ View Workflow</a>
                    <button onclick="cloneRun({{ run_id }})" class="btn" style="background: #10b981;">üîÑ Clone This Run</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="/download/{{ run_id }}/csv" class="btn">üì• Download CSV</a>
                    <a href="/download/{{ run_id }}/excel" class="btn">üìä Download Excel</a>
                </div>
            </div>

            {% if columns %}
            <div style="margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 4px; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; cursor: pointer; background: #fff; border-radius: 4px 4px 0 0;" onclick="toggleColumns()">
                    <strong style="font-size: 13px;">
                        <span id="columnsToggleIcon">‚ñº</span> Columns ({{ columns|length }})
                    </strong>
                    <button onclick="event.stopPropagation(); copyAllColumns()" class="btn btn-sm" style="background: #10b981; padding: 4px 10px; font-size: 11px;" title="Copy all column names as comma-separated">
                        üìã Copy All
                    </button>
                </div>
                <div id="columnsSection" class="columns-display" style="padding: 10px; border-top: 1px solid #e0e0e0;">
                    {% for col in columns %}
                        <span class="column-tag" onclick="copyToClipboard('{{ col }}', this)" title="Click to copy">{{ col }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Group Navigation - Compact -->
            <div style="background: #f0f7fc; padding: 10px 12px; border-radius: 4px; margin-bottom: 12px; border-left: 3px solid #337ab7;">
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 12px;">
                    <strong style="color: #337ab7; white-space: nowrap;">üìä Groups:</strong>
                    {% for stat in group_stats %}
                    <a href="/run/{{ run_id }}?group={{ stat.size }}&page=1&per_page=50" 
                       class="group-btn {% if current_group == stat.size %}active{% endif %}"
                       style="padding: 4px 10px; font-size: 11px; display: inline-flex; align-items: center; gap: 4px;"
                       title="Side A: {{ stat.count_a }} ({{ stat.unique_keys_a }} unique) | Side B: {{ stat.count_b }} ({{ stat.unique_keys_b }} unique)">
                        {{ stat.size }}-Col
                        <span class="group-badge" style="font-size: 9px; padding: 1px 4px;">{{ stat.count_a + stat.count_b }}</span>
                    </a>
                    {% endfor %}
                    <span style="color: #ccc; margin: 0 4px;">|</span>
                    <a href="/run/{{ run_id }}" class="group-btn {% if not current_group %}active{% endif %}"
                       style="padding: 4px 10px; font-size: 11px;">
                        All
                    </a>
                </div>
            </div>

            {% if current_group %}
            <!-- Detailed view of specific group -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #337ab7;">
                <h3 style="margin: 0; color: #333; font-size: 1.1em;">{{ current_group }}-Column Combinations</h3>
                {% if pagination %}
                <span style="color: #666; font-size: 11px;">
                    {{ pagination.per_page }}/page | A: {{ pagination.total_in_group_a }} | B: {{ pagination.total_in_group_b }}
                </span>
                {% endif %}
            </div>

            <div class="comparison-tables">
                <!-- Side A Table -->
                <div class="table-panel">
                    <div class="table-header">
                        <div class="table-title">Side A: {{ file_a }}</div>
                        <div class="table-badge">{{ (grouped_a[current_group]|length) if (current_group in grouped_a) else 0 }} combinations</div>
                    </div>

                    {% if current_group in grouped_a and grouped_a[current_group] %}
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Columns</th>
                                <th style="width: 10%;">Unique</th>
                                <th style="width: 10%;">Duplicates</th>
                                <th style="width: 25%;">Uniqueness</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 23%;">Export Records</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pagination %}
                                {% set offset = (pagination.current_page - 1) * pagination.per_page %}
                                {% set results_slice = grouped_a[current_group][offset:offset + pagination.per_page] %}
                            {% else %}
                                {% set results_slice = grouped_a[current_group][:10] %}
                            {% endif %}
                            {% for result in results_slice %}
                            <tr class="{% if result.is_unique_key %}unique-key{% else %}has-duplicates{% endif %}">
                                <td><strong>{{ result.columns }}</strong></td>
                                <td>{{ result.unique_rows }}</td>
                                <td>{{ result.duplicate_count }}</td>
                                <td>
                                    <div class="score-bar">
                                        <div class="score-bar-fill">
                                            <div class="score-bar-value {% if result.uniqueness_score == 100 %}high{% elif result.uniqueness_score >= 70 %}medium{% else %}low{% endif %}"
                                                 style="width: {{ result.uniqueness_score }}%"></div>
                                        </div>
                                        <span class="score-text">{{ result.uniqueness_score }}%</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge {% if result.is_unique_key %}unique{% else %}duplicate{% endif %}">
                                        {% if result.is_unique_key %}‚úì Unique{% else %}‚ö† Duplicates{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                                        {% if result.unique_rows > 0 %}
                                        <a href="/download/{{ run_id }}/unique-records?side=A&columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #5cb85c;"
                                           title="Unique: {{ result.unique_rows }}">
                                            U:{{ result.unique_rows }}
                                        </a>
                                        {% endif %}
                                        {% if result.duplicate_count > 0 %}
                                        <a href="/download/{{ run_id }}/duplicate-records?side=A&columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #f0ad4e;"
                                           title="Duplicates: {{ result.duplicate_count }}">
                                            D:{{ result.duplicate_count }}
                                        </a>
                                        {% endif %}
                                        <a href="/comparison/{{ run_id }}/view?columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #337ab7;"
                                           title="View comparison">
                                            üëÅÔ∏è
                                        </a>
                                        <a href="/download/{{ run_id }}/comparison?columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #777;"
                                           title="Download Excel">
                                            üì•
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">No results in this group</div>
                    {% endif %}
                </div>

                <!-- Side B Table -->
                <div class="table-panel">
                    <div class="table-header">
                        <div class="table-title">Side B: {{ file_b }}</div>
                        <div class="table-badge">{{ (grouped_b[current_group]|length) if (current_group in grouped_b) else 0 }} combinations</div>
                    </div>

                    {% if current_group in grouped_b and grouped_b[current_group] %}
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Columns</th>
                                <th style="width: 10%;">Unique</th>
                                <th style="width: 10%;">Duplicates</th>
                                <th style="width: 25%;">Uniqueness</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 23%;">Export Records</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pagination %}
                                {% set offset = (pagination.current_page - 1) * pagination.per_page %}
                                {% set results_slice = grouped_b[current_group][offset:offset + pagination.per_page] %}
                            {% else %}
                                {% set results_slice = grouped_b[current_group][:10] %}
                            {% endif %}
                            {% for result in results_slice %}
                            <tr class="{% if result.is_unique_key %}unique-key{% else %}has-duplicates{% endif %}">
                                <td><strong>{{ result.columns }}</strong></td>
                                <td>{{ result.unique_rows }}</td>
                                <td>{{ result.duplicate_count }}</td>
                                <td>
                                    <div class="score-bar">
                                        <div class="score-bar-fill">
                                            <div class="score-bar-value {% if result.uniqueness_score == 100 %}high{% elif result.uniqueness_score >= 70 %}medium{% else %}low{% endif %}"
                                                 style="width: {{ result.uniqueness_score }}%"></div>
                                        </div>
                                        <span class="score-text">{{ result.uniqueness_score }}%</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge {% if result.is_unique_key %}unique{% else %}duplicate{% endif %}">
                                        {% if result.is_unique_key %}‚úì Unique{% else %}‚ö† Duplicates{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                                        {% if result.unique_rows > 0 %}
                                        <a href="/download/{{ run_id }}/unique-records?side=B&columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #5cb85c;"
                                           title="Unique: {{ result.unique_rows }}">
                                            U:{{ result.unique_rows }}
                                        </a>
                                        {% endif %}
                                        {% if result.duplicate_count > 0 %}
                                        <a href="/download/{{ run_id }}/duplicate-records?side=B&columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #f0ad4e;"
                                           title="Duplicates: {{ result.duplicate_count }}">
                                            D:{{ result.duplicate_count }}
                                        </a>
                                        {% endif %}
                                        <a href="/comparison/{{ run_id }}/view?columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #337ab7;"
                                           title="View comparison">
                                            üëÅÔ∏è
                                        </a>
                                        <a href="/download/{{ run_id }}/comparison?columns={{ result.columns | urlencode }}" 
                                           class="btn btn-sm" 
                                           style="padding: 2px 6px; font-size: 10px; background: #777;"
                                           title="Download Excel">
                                            üì•
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">No results in this group</div>
                    {% endif %}
                </div>
            </div>

            <!-- Pagination for group -->
            {% if pagination and pagination.total_pages > 1 %}
            <div class="pagination">
                <div style="color: #666; margin-right: 20px;">
                    Page {{ pagination.current_page }} of {{ pagination.total_pages }}
                </div>
                {% if pagination.has_prev %}
                <a href="/run/{{ run_id }}?group={{ current_group }}&page=1&per_page={{ pagination.per_page }}" class="btn btn-sm">¬´ First</a>
                <a href="/run/{{ run_id }}?group={{ current_group }}&page={{ pagination.current_page - 1 }}&per_page={{ pagination.per_page }}" class="btn btn-sm">‚Äπ Prev</a>
                {% else %}
                <button class="btn btn-sm" disabled style="opacity: 0.5;">¬´ First</button>
                <button class="btn btn-sm" disabled style="opacity: 0.5;">‚Äπ Prev</button>
                {% endif %}
                
                <span style="padding: 8px 16px; background: #667eea; color: white; border-radius: 6px; font-weight: 600;">
                    {{ pagination.current_page }}
                </span>
                
                {% if pagination.has_next %}
                <a href="/run/{{ run_id }}?group={{ current_group }}&page={{ pagination.current_page + 1 }}&per_page={{ pagination.per_page }}" class="btn btn-sm">Next ‚Ä∫</a>
                <a href="/run/{{ run_id }}?group={{ current_group }}&page={{ pagination.total_pages }}&per_page={{ pagination.per_page }}" class="btn btn-sm">Last ¬ª</a>
                {% else %}
                <button class="btn btn-sm" disabled style="opacity: 0.5;">Next ‚Ä∫</button>
                <button class="btn btn-sm" disabled style="opacity: 0.5;">Last ¬ª</button>
                {% endif %}
                
                <select onchange="window.location.href='/run/{{ run_id }}?group={{ current_group }}&page=1&per_page=' + this.value"
                        style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25/page</option>
                    <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50/page</option>
                    <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100/page</option>
                    <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200/page</option>
                </select>
            </div>
            {% endif %}

            {% else %}
            <!-- Summary view of all groups (showing top 10 from each) -->
            <div style="padding: 8px 12px; background: #f8f9fa; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid #5cb85c;">
                <strong style="color: #333; font-size: 13px;">üìã Summary View</strong>
                <span style="color: #666; font-size: 11px; margin-left: 10px;">Top 10 from each group - Click group above to see all</span>
            </div>

            {% for stat in group_stats %}
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f0f4ff; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid #667eea;">
                    <h4 style="color: #667eea; margin: 0; font-size: 1em;">
                        {{ stat.size }}-Column 
                        <span style="color: #999; font-size: 11px; font-weight: normal;">
                            (A: {{ stat.count_a }}, B: {{ stat.count_b }})
                        </span>
                    </h4>
                    <a href="/run/{{ run_id }}?group={{ stat.size }}" class="btn btn-sm" style="padding: 3px 10px; font-size: 11px;">
                        View All ‚Üí
                    </a>
                </div>

                <div class="comparison-tables">
                    <div class="table-panel">
                        <div class="table-header">
                            <div class="table-title">Side A - Top 10</div>
                        </div>
                        {% if stat.size in grouped_a %}
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th style="width: 22%;">Columns</th>
                                    <th style="width: 12%;">Unique</th>
                                    <th style="width: 12%;">Duplicates</th>
                                    <th style="width: 12%;">Score</th>
                                    <th style="width: 12%;">Status</th>
                                    <th style="width: 30%;">Export</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in grouped_a[stat.size][:10] %}
                                <tr class="{% if result.is_unique_key %}unique-key{% else %}has-duplicates{% endif %}">
                                    <td><strong>{{ result.columns }}</strong></td>
                                    <td>{{ result.unique_rows }}</td>
                                    <td>{{ result.duplicate_count }}</td>
                                    <td>{{ result.uniqueness_score }}%</td>
                                    <td>
                                        <span class="status-badge {% if result.is_unique_key %}unique{% else %}duplicate{% endif %}">
                                            {% if result.is_unique_key %}‚úì{% else %}‚ö†{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                                            {% if result.unique_rows > 0 %}
                                            <a href="/download/{{ run_id }}/unique-records?side=A&columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #5cb85c;">
                                                U
                                            </a>
                                            {% endif %}
                                            {% if result.duplicate_count > 0 %}
                                            <a href="/download/{{ run_id }}/duplicate-records?side=A&columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #f0ad4e;">
                                                D
                                            </a>
                                            {% endif %}
                                            <a href="/comparison/{{ run_id }}/view?columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #337ab7;">
                                                üëÅÔ∏è
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if stat.count_a > 10 %}
                        <div style="text-align: center; margin-top: 8px; color: #666; font-size: 11px;">
                            ... and {{ stat.count_a - 10 }} more 
                            <a href="/run/{{ run_id }}?group={{ stat.size }}" style="color: #337ab7;">View All</a>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="table-panel">
                        <div class="table-header">
                            <div class="table-title">Side B - Top 10</div>
                        </div>
                        {% if stat.size in grouped_b %}
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th style="width: 22%;">Columns</th>
                                    <th style="width: 12%;">Unique</th>
                                    <th style="width: 12%;">Duplicates</th>
                                    <th style="width: 12%;">Score</th>
                                    <th style="width: 12%;">Status</th>
                                    <th style="width: 30%;">Export</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in grouped_b[stat.size][:10] %}
                                <tr class="{% if result.is_unique_key %}unique-key{% else %}has-duplicates{% endif %}">
                                    <td><strong>{{ result.columns }}</strong></td>
                                    <td>{{ result.unique_rows }}</td>
                                    <td>{{ result.duplicate_count }}</td>
                                    <td>{{ result.uniqueness_score }}%</td>
                                    <td>
                                        <span class="status-badge {% if result.is_unique_key %}unique{% else %}duplicate{% endif %}">
                                            {% if result.is_unique_key %}‚úì{% else %}‚ö†{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 2px; flex-wrap: wrap;">
                                            {% if result.unique_rows > 0 %}
                                            <a href="/download/{{ run_id }}/unique-records?side=B&columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #5cb85c;">
                                                U
                                            </a>
                                            {% endif %}
                                            {% if result.duplicate_count > 0 %}
                                            <a href="/download/{{ run_id }}/duplicate-records?side=B&columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #f0ad4e;">
                                                D
                                            </a>
                                            {% endif %}
                                            <a href="/comparison/{{ run_id }}/view?columns={{ result.columns | urlencode }}" 
                                               class="btn btn-sm" 
                                               style="padding: 2px 5px; font-size: 9px; background: #337ab7;">
                                                üëÅÔ∏è
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if stat.count_b > 10 %}
                        <div style="text-align: center; margin-top: 8px; color: #666; font-size: 11px;">
                            ... and {{ stat.count_b - 10 }} more 
                            <a href="/run/{{ run_id }}?group={{ stat.size }}" style="color: #337ab7;">View All</a>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    
    <script>
        // Show loading spinner on page load
        window.addEventListener('load', function() {
            document.getElementById('loadingOverlay').classList.remove('active');
        });

        // Show loading spinner for navigation
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        // Attach loading to all navigation links and buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Attach to buttons that navigate
            const navButtons = document.querySelectorAll('a.btn, a.group-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (!this.getAttribute('href').startsWith('/download')) {
                        showLoading();
                    }
                });
            });

            // Attach to pagination links
            const paginationLinks = document.querySelectorAll('.pagination a');
            paginationLinks.forEach(link => {
                link.addEventListener('click', showLoading);
            });
        });

        function copyToClipboard(text, element) {
            // Create temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('Copied: ' + text);
                
                // Visual feedback
                const originalBg = element.style.background;
                element.style.background = '#d9edf7';
                setTimeout(() => {
                    element.style.background = originalBg;
                }, 300);
            } catch (err) {
                showToast('Failed to copy');
            }
            
            document.body.removeChild(textarea);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function toggleColumns() {
            const section = document.getElementById('columnsSection');
            const icon = document.getElementById('columnsToggleIcon');
            
            if (section.style.display === 'none') {
                section.style.display = 'flex';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function copyAllColumns() {
            const columns = [
                {% for col in columns %}'{{ col }}'{% if not loop.last %},{% endif %}{% endfor %}
            ];
            const allColumnsText = columns.join(',');
            
            const textarea = document.createElement('textarea');
            textarea.value = allColumnsText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('‚úÖ Copied all ' + columns.length + ' columns!');
            } catch (err) {
                showToast('‚ùå Failed to copy');
            }
            
            document.body.removeChild(textarea);
        }

        async function cloneRun(runId) {
            if (!confirm(`Clone Run #${runId}?\n\nThis will copy all settings to the home page where you can modify and re-analyze.`)) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/clone/${runId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Clone Failed: ' + data.error);
                    return;
                }
                
                // Store in sessionStorage to pass to home page
                sessionStorage.setItem('clonedRun', JSON.stringify(data));
                
                // Redirect to home page
                alert(`‚úÖ Run #${runId} settings cloned!\n\nRedirecting to home page...`);
                window.location.href = '/';
                
            } catch (error) {
                alert('Network Error: ' + error.message);
            }
        }
    </script>
</body>
</html>

