<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unique Key Identifier - Modern Analysis Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js for React-like reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .animate-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-scale-in {
            animation: scaleIn 0.2s ease-out;
        }
        
        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        /* Column Button Hover Effect */
        .column-btn {
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }
        
        .column-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .column-btn:hover::before {
            width: 100%;
            height: 100%;
        }
        
        .column-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Combination Chip Styles */
        .combo-chip {
            transition: all 0.2s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(10px);
        }
        
        .combo-chip:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(2px);
        }
        
        /* Builder Area Enhancement */
        .builder-area {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
            border: 2px dashed rgba(156, 163, 175, 0.3);
            transition: all 0.2s ease;
        }
        
        .builder-area.has-items {
            border-style: solid;
            border-color: rgba(156, 163, 175, 0.5);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(249, 250, 251, 1) 100%);
        }
        
        /* Tag/Chip Removal Animation */
        @keyframes chipRemove {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(0.8) rotateZ(5deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotateZ(10deg);
            }
        }
        
        /* Panel Glow Effects */
        .panel-glow-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .panel-glow-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.1);
        }
        
        /* Input Focus Enhancement */
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Loading Pulse */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Smooth Section Transitions */
        .section-card {
            transition: all 0.3s ease;
        }
        
        .section-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        /* Badge Improvements */
        .badge {
            font-weight: 600;
            letter-spacing: 0.025em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle Switch Enhancement */
        .toggle-switch {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-primary to-secondary min-h-screen" x-data="appData()">
    
    <!-- Toast Notifications -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-2"
         class="fixed top-4 right-4 z-50 max-w-md"
         x-cloak>
        <div :class="{
            'bg-green-500': toast.type === 'success',
            'bg-red-500': toast.type === 'error',
            'bg-blue-500': toast.type === 'info',
            'bg-yellow-500': toast.type === 'warning'
        }" class="text-white px-6 py-4 rounded-lg shadow-2xl flex items-start space-x-3">
            <div class="flex-shrink-0">
                <template x-if="toast.type === 'success'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </template>
                <template x-if="toast.type === 'error'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </template>
                <template x-if="toast.type === 'info'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </template>
            </div>
            <div class="flex-1">
                <p class="font-semibold" x-text="toast.title"></p>
                <p class="text-sm mt-1 opacity-90" x-text="toast.message"></p>
            </div>
            <button @click="toast.show = false" class="flex-shrink-0 text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div x-show="loading" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-40 flex items-center justify-center"
         x-cloak>
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="flex flex-col items-center">
                <!-- Spinner -->
                <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                
                <h3 class="text-2xl font-bold text-gray-800 mt-6">Analyzing Files...</h3>
                <p class="text-gray-600 mt-2 text-center">Please wait while we process your data</p>
                
                <!-- Progress Steps -->
                <div class="w-full mt-6 space-y-3">
                    <template x-for="(step, index) in progressSteps" :key="index">
                        <div class="flex items-center space-x-3">
                            <div :class="{
                                'bg-green-500': step.status === 'completed',
                                'bg-primary animate-pulse': step.status === 'active',
                                'bg-gray-300': step.status === 'pending'
                            }" class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                                <template x-if="step.status === 'completed'">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </template>
                                <template x-if="step.status !== 'completed'">
                                    <span x-text="index + 1"></span>
                                </template>
                            </div>
                            <span :class="{
                                'text-gray-800 font-semibold': step.status === 'active',
                                'text-gray-600': step.status === 'pending',
                                'text-green-600': step.status === 'completed'
                            }" class="text-sm" x-text="step.name"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="h-screen flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white bg-opacity-10 backdrop-blur-md border-b border-white border-opacity-20 flex-shrink-0">
            <div class="w-full px-3 py-2">
                <h1 class="text-xl font-bold text-white text-center flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    <span>Unique Key Identifier</span>
                </h1>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="flex-1 w-full px-2 py-2 overflow-y-auto">
            
            <!-- Single Full-Width Layout -->
            <div class="space-y-1 h-full flex flex-col">
                <!-- Configuration Panel - More Compact -->
                <div class="bg-white rounded-xl shadow-lg p-2 animate-slide-in text-sm flex-shrink-0 section-card">
                    <h2 class="text-sm font-bold text-gray-800 mb-1 flex items-center">
                        <svg class="w-3 h-3 mr-1 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configuration
                    </h2>
                    
                <form @submit.prevent="submitAnalysis">
                    <!-- All fields in horizontal rows - More compact -->
                    <div class="grid grid-cols-12 gap-1.5 mb-1">
                        <!-- Row 1: Directory, File A, File B -->
                        <div class="col-span-3">
                            <label class="block text-gray-700 font-semibold mb-0.5 text-xs">üìÅ Directory</label>
                            <input type="text" 
                                   x-model="workingDirectory" 
                                   @input="debouncePreview()"
                                   placeholder="Default folder"
                                   class="w-full px-2 py-1 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                        </div>
                        
                        <div class="col-span-3">
                            <label class="block text-gray-700 font-semibold mb-0.5 text-xs">üìÑ File A</label>
                            <input type="text" 
                                   x-model="fileA" 
                                   @input="debouncePreview()"
                                   placeholder="file_a.csv"
                                   required
                                   class="w-full px-2 py-1 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                        </div>
                        
                        <div class="col-span-3">
                            <label class="block text-gray-700 font-semibold mb-0.5 text-xs">üìÑ File B</label>
                            <input type="text" 
                                   x-model="fileB" 
                                   @input="debouncePreview()"
                                   placeholder="file_b.csv"
                                   required
                                   class="w-full px-2 py-1 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                        </div>
                        
                        <!-- Row 1: Columns, Row Limit, Quality Check -->
                        <div class="col-span-1">
                            <label class="block text-gray-700 font-semibold mb-0.5 text-xs">üî¢ Cols</label>
                            <input type="number" 
                                   x-model="numColumns" 
                                   :readonly="includedCombinations.length > 0"
                                   min="1"
                                   required
                                   :class="includedCombinations.length > 0 ? 'bg-gray-100 cursor-not-allowed' : ''"
                                   class="w-full px-2 py-1 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                        </div>
                        
                        <div class="col-span-1">
                            <label class="block text-gray-700 font-semibold mb-0.5 text-xs">üìä Rows</label>
                            <input type="number" 
                                   x-model="maxRows" 
                                   min="0"
                                   placeholder="0"
                                   class="w-full px-2 py-1 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                        </div>
                        
                        <div class="col-span-1 flex items-end">
                            <button type="submit" 
                                    :disabled="loading"
                                    title="Analyze Files"
                                    class="w-full btn-primary text-white font-semibold py-1 px-2 rounded-lg text-xs shadow-md">
                                ‚ö° Analyze
                            </button>
                        </div>
                    </div>
                    
                    <!-- Row 2: Quality Check and Previous Analysis - More compact -->
                    <div class="grid grid-cols-12 gap-1.5">
                        <div class="col-span-2 flex items-center">
                            <label class="flex items-center cursor-pointer text-xs">
                                <input type="checkbox" 
                                       x-model="dataQualityCheck"
                                       class="mr-1 h-3 w-3 text-primary border-gray-300 rounded">
                                <span class="font-semibold text-gray-700">Quality Check</span>
                            </label>
                        </div>
                        
                        <div class="col-span-5" x-show="runs.length > 0">
                            <select @change="if($event.target.value) window.location.href='/run/' + $event.target.value"
                                    class="w-full px-2 py-0.5 text-xs border-2 border-gray-300 rounded-lg focus:border-primary transition-all shadow-sm">
                                <option value="">üìä View Results...</option>
                                <template x-for="run in runs" :key="run.id">
                                    <option :value="run.id" x-text="run.label"></option>
                                </template>
                            </select>
                        </div>
                        
                        <div class="col-span-5" x-show="runs.length > 0">
                            <select @change="if($event.target.value) cloneRun($event.target.value)"
                                    class="w-full px-2 py-0.5 text-xs border-2 border-green-400 rounded-lg focus:border-green-500 transition-all bg-green-50 shadow-sm hover:shadow-md">
                                <option value="">üîÑ Clone Settings...</option>
                                <template x-for="run in runs" :key="run.id">
                                    <option :value="run.id" x-text="run.label"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </form>
                </div>

                
                <!-- Columns & Selection Panel (Full Width) - Flexible height -->
                <div class="bg-white rounded-xl shadow-lg p-2 animate-slide-in text-sm flex-1 flex flex-col overflow-hidden section-card">
                    <h2 class="text-sm font-bold text-gray-800 mb-1 flex items-center flex-shrink-0">
                        <svg class="w-3 h-3 mr-1 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 0v10"></path>
                        </svg>
                        Available Columns & Combination Builder
                    </h2>
                    
                    <!-- Initial State -->
                    <div x-show="!fileA && !fileB && !columnsLoading" class="text-center py-16 animate-fade-in">
                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="text-lg font-bold gradient-text mb-2">No Files Selected</h3>
                        <p class="text-gray-500 text-sm">üìù Enter file names in the configuration panel to see available columns</p>
                    </div>
            
            <!-- Loading Indicator for Column Preview -->
            <div x-show="columnsLoading" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-y-4"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 class="text-center py-12"
                 x-cloak>
                <div class="flex flex-col items-center space-y-4">
                    <div class="relative">
                        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 w-16 h-16 border-4 border-secondary border-b-transparent rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 1s;"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold gradient-text">üîç Loading Files...</h3>
                        <p class="text-gray-600 mt-2 text-sm font-medium">Reading headers and counting rows</p>
                        <p class="text-xs text-gray-500 mt-1 italic">This may take a few seconds for large files</p>
                    </div>
                    <div class="flex items-center space-x-2 text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                        <svg class="w-4 h-4 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <span x-text="'Processing: ' + fileA + ' & ' + fileB" class="font-medium"></span>
                    </div>
                </div>
            </div>
            
            <!-- Column Selector (shown when files are loaded) -->
            <div x-show="columnsLoaded && !columnsLoading" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-y-4"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 class="flex-1 flex flex-col overflow-hidden"
                 x-cloak>
                
                <!-- Info Bar - More compact -->
                <div class="bg-gradient-to-r from-primary to-secondary text-white px-2 py-1.5 flex-shrink-0 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center justify-between gap-2 text-xs">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex items-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="font-semibold">File A:</span>
                                <span x-text="fileInfo.rowsA + ' rows'"></span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="font-semibold">File B:</span>
                                <span x-text="fileInfo.rowsB + ' rows'"></span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"></path>
                                </svg>
                                <span class="font-semibold">Columns:</span>
                                <span x-text="columns.length" class="font-bold text-yellow-300"></span>
                            </div>
                        </div>
                        <button @click="resetAll()" 
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg font-semibold transition-all flex items-center space-x-1 hover:shadow-md hover:scale-105">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Reset All</span>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-12 gap-2 flex-1 overflow-hidden">
                    
                    <!-- Column Pool - Reduced from col-span-4 to col-span-3 (10% reduction) -->
                    <div class="col-span-3 p-2 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl flex flex-col overflow-hidden shadow-inner">
                        <!-- Builder Toggle -->
                        <div class="flex items-center justify-between mb-2 flex-shrink-0">
                            <span class="text-xs font-bold text-gray-700 flex items-center space-x-1">
                                <span class="inline-block w-2 h-2 rounded-full animate-pulse" :class="activeBuilder === 'include' ? 'bg-green-500' : 'bg-red-500'"></span>
                                <span :class="activeBuilder === 'include' ? 'text-green-600' : 'text-red-600'" x-text="activeBuilder === 'include' ? '‚úÖ Include Mode' : '‚ùå Exclude Mode'"></span>
                            </span>
                            <button @click="activeBuilder = activeBuilder === 'include' ? 'exclude' : 'include'"
                                    class="relative inline-flex h-5 w-10 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-1 toggle-switch"
                                    :class="activeBuilder === 'include' ? 'bg-green-500' : 'bg-red-500'">
                                <span class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow-md ring-0 transition-all duration-200 ease-in-out"
                                      :class="activeBuilder === 'include' ? 'translate-x-5' : 'translate-x-0'"></span>
                            </button>
                        </div>
                        
                        <!-- Columns List (Horizontal) - Full height -->
                        <div class="flex flex-wrap gap-1.5 overflow-y-auto p-2 bg-white rounded-lg border-2 border-gray-200 flex-1 shadow-sm">
                            <template x-for="col in columns" :key="col">
                                <button @click="addColumnToActiveBuilder(col)" 
                                        class="column-btn px-2.5 py-1 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-primary hover:to-secondary hover:text-white rounded-lg text-xs font-semibold border border-gray-300 hover:border-primary transition-all whitespace-nowrap shadow-sm hover:shadow-md">
                                    <span x-text="col" class="relative z-10"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Include Panel - Better space distribution -->
                    <div class="col-span-4 p-2 bg-gradient-to-br from-green-50 to-green-100 rounded-xl flex flex-col overflow-hidden panel-glow-green shadow-md">
                        <div class="flex items-center justify-between mb-2 flex-shrink-0">
                            <span class="text-xs font-bold text-green-700 flex items-center space-x-1.5">
                                <span class="text-sm">‚úÖ</span>
                                <span>Include Combinations</span>
                                <span class="badge bg-green-500 text-white px-2 py-0.5 rounded-full text-xs shadow-sm" x-text="includedCombinations.length"></span>
                            </span>
                        </div>
                        
                        <!-- Builder -->
                        <div class="bg-white border-2 border-green-300 rounded-lg p-2 mb-2 flex-shrink-0 shadow-sm">
                            <div class="builder-area min-h-12 max-h-32 overflow-y-auto rounded-lg p-2 mb-2" 
                                 :class="includeBuilder.length > 0 ? 'has-items bg-green-50' : 'bg-gradient-to-br from-green-50 to-white'">
                                <template x-if="includeBuilder.length === 0">
                                    <p class="text-gray-400 text-xs text-center py-2 italic">üëÜ Click columns to add...</p>
                                </template>
                                <div class="flex flex-wrap gap-1.5">
                                    <template x-for="(col, idx) in includeBuilder" :key="idx">
                                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-2.5 py-1 rounded-lg text-xs font-semibold flex items-center space-x-1.5 shadow-md hover:shadow-lg transition-all hover:scale-105 animate-scale-in">
                                            <span x-text="col"></span>
                                            <button @click="includeBuilder.splice(idx, 1)" class="hover:text-red-200 font-bold text-base leading-none hover:scale-125 transition-transform">√ó</button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="flex gap-1.5">
                                <button @click="addIncludeCombination()" 
                                        title="Add this combination to the list"
                                        class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-1.5 rounded-lg text-xs font-semibold transition-all shadow-md hover:shadow-lg hover:scale-105">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <button @click="includeBuilder = []" 
                                        title="Clear the builder"
                                        class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white px-2 py-1 rounded-lg text-xs font-semibold transition-all shadow-md hover:shadow-lg">
                                    üóëÔ∏è Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Saved Combinations - Full remaining height -->
                        <div class="bg-white rounded-lg p-2 overflow-y-auto flex-1 shadow-inner border border-green-200">
                            <template x-if="includedCombinations.length === 0">
                                <p class="text-gray-400 text-xs text-center py-4 italic">üìù No combinations added yet</p>
                            </template>
                            <div class="space-y-1.5">
                                <template x-for="(combo, idx) in includedCombinations" :key="idx">
                                    <div class="combo-chip bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-2 flex justify-between items-center shadow-sm hover:border-green-400 animate-scale-in">
                                        <span class="text-xs font-semibold text-gray-700 break-all flex items-center">
                                            <span class="inline-block w-1.5 h-1.5 bg-green-500 rounded-full mr-2"></span>
                                            <span x-text="combo"></span>
                                        </span>
                                        <button @click="includedCombinations.splice(idx, 1)" 
                                                title="Remove this combination"
                                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-lg text-xs transition-all flex-shrink-0 ml-2 shadow-sm hover:shadow-md hover:scale-110 font-bold">
                                            √ó
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exclude Panel - Increased from col-span-4 to col-span-5 -->
                    <div class="col-span-5 p-2 bg-gradient-to-br from-red-50 to-red-100 rounded-xl flex flex-col overflow-hidden panel-glow-red shadow-md">
                        <div class="flex items-center justify-between mb-2 flex-shrink-0">
                            <span class="text-xs font-bold text-red-700 flex items-center space-x-1.5">
                                <span class="text-sm">‚ùå</span>
                                <span>Exclude Combinations</span>
                                <span class="badge bg-red-500 text-white px-2 py-0.5 rounded-full text-xs shadow-sm" x-text="excludedCombinations.length"></span>
                            </span>
                        </div>
                        
                        <!-- Builder -->
                        <div class="bg-white border-2 border-red-300 rounded-lg p-2 mb-2 flex-shrink-0 shadow-sm">
                            <div class="builder-area min-h-12 max-h-32 overflow-y-auto rounded-lg p-2 mb-2"
                                 :class="excludeBuilder.length > 0 ? 'has-items bg-red-50' : 'bg-gradient-to-br from-red-50 to-white'">
                                <template x-if="excludeBuilder.length === 0">
                                    <p class="text-gray-400 text-xs text-center py-2 italic">üëÜ Click columns to add...</p>
                                </template>
                                <div class="flex flex-wrap gap-1.5">
                                    <template x-for="(col, idx) in excludeBuilder" :key="idx">
                                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white px-2.5 py-1 rounded-lg text-xs font-semibold flex items-center space-x-1.5 shadow-md hover:shadow-lg transition-all hover:scale-105 animate-scale-in">
                                            <span x-text="col"></span>
                                            <button @click="excludeBuilder.splice(idx, 1)" class="hover:text-yellow-200 font-bold text-base leading-none hover:scale-125 transition-transform">√ó</button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="flex gap-1.5">
                                <button @click="addExcludeCombination()" 
                                        title="Add this combination to the list"
                                        class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-1.5 rounded-lg text-xs font-semibold transition-all shadow-md hover:shadow-lg hover:scale-105">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <button @click="excludeBuilder = []" 
                                        title="Clear the builder"
                                        class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white px-2 py-1 rounded-lg text-xs font-semibold transition-all shadow-md hover:shadow-lg">
                                    üóëÔ∏è Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Saved Combinations - Full remaining height -->
                        <div class="bg-white rounded-lg p-2 overflow-y-auto flex-1 shadow-inner border border-red-200">
                            <template x-if="excludedCombinations.length === 0">
                                <p class="text-gray-400 text-xs text-center py-4 italic">üìù No combinations added yet</p>
                            </template>
                            <div class="space-y-1.5">
                                <template x-for="(combo, idx) in excludedCombinations" :key="idx">
                                    <div class="combo-chip bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-300 rounded-lg p-2 flex justify-between items-center shadow-sm hover:border-red-400 animate-scale-in">
                                        <span class="text-xs font-semibold text-gray-700 break-all flex items-center">
                                            <span class="inline-block w-1.5 h-1.5 bg-red-500 rounded-full mr-2"></span>
                                            <span x-text="combo"></span>
                                        </span>
                                        <button @click="excludedCombinations.splice(idx, 1)" 
                                                title="Remove this combination"
                                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg text-xs transition-all flex-shrink-0 ml-2 shadow-sm hover:shadow-md hover:scale-110 font-bold">
                                            √ó
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            </div>
            <!-- End of Columns Panel -->
            
            </div>
            <!-- End of Full-Width Layout -->
        </div>
    </div>
    
    <script>
        function appData() {
            return {
                // Form data
                fileA: '',
                fileB: '',
                workingDirectory: '',
                numColumns: 3,
                maxRows: 0,  // 0 = auto-sampling
                dataQualityCheck: false,  // Data quality check toggle
                
                // Column selection
                columns: [],
                columnsLoaded: false,
                columnsLoading: false,  // NEW: Track loading state
                fileInfo: { rowsA: 0, rowsB: 0 },
                
                // Builders
                activeBuilder: 'include',
                includeBuilder: [],
                excludeBuilder: [],
                includedCombinations: [],
                excludedCombinations: [],
                
                // UI State
                loading: false,
                toast: {
                    show: false,
                    type: 'info',
                    title: '',
                    message: ''
                },
                
                // Progress
                progressSteps: [
                    { name: 'Reading CSV files', status: 'pending' },
                    { name: 'Validating columns', status: 'pending' },
                    { name: 'Analyzing combinations', status: 'pending' },
                    { name: 'Calculating scores', status: 'pending' },
                    { name: 'Storing results', status: 'pending' }
                ],
                
                // Previous runs
                runs: {{ runs | tojson | safe }},
                
                // Debounce timer
                previewTimer: null,
                
                init() {
                    // Watch for combination changes
                    this.$watch('includedCombinations', () => {
                        if (this.includedCombinations.length > 0) {
                            this.numColumns = 1;
                        } else if (this.numColumns === 1) {
                            this.numColumns = 3;
                        }
                    });
                    
                    // Check if we have cloned run data
                    this.loadClonedRun();
                },
                
                loadClonedRun() {
                    const clonedData = sessionStorage.getItem('clonedRun');
                    if (clonedData) {
                        try {
                            const data = JSON.parse(clonedData);
                            
                            // Populate form fields
                            this.fileA = data.file_a;
                            this.fileB = data.file_b;
                            this.numColumns = data.num_columns;
                            this.maxRows = data.max_rows || 0;
                            this.workingDirectory = data.working_directory || '';
                            this.dataQualityCheck = data.data_quality_check || false;
                            
                            // Parse combinations
                            if (data.expected_combinations) {
                                this.includedCombinations = data.expected_combinations.split('\n').filter(line => line.trim());
                            }
                            if (data.excluded_combinations) {
                                this.excludedCombinations = data.excluded_combinations.split('\n').filter(line => line.trim());
                            }
                            
                            // Trigger column preview
                            setTimeout(() => {
                                this.previewColumns();
                            }, 500);
                            
                            // Show success message
                            this.showToast('success', 'Run Cloned!', 
                                `Run #${data.run_id} settings loaded. Modify and click Analyze!`);
                            
                            // Clear sessionStorage
                            sessionStorage.removeItem('clonedRun');
                            
                        } catch (error) {
                            console.error('Error loading cloned run:', error);
                            sessionStorage.removeItem('clonedRun');
                        }
                    }
                },
                
                debouncePreview() {
                    clearTimeout(this.previewTimer);
                    this.previewTimer = setTimeout(() => {
                        this.previewColumns();
                    }, 800);
                },
                
                async previewColumns() {
                    if (!this.fileA || !this.fileB) {
                        this.columnsLoaded = false;
                        this.columnsLoading = false;
                        return;
                    }
                    
                    // Show loading state
                    this.columnsLoading = true;
                    this.columnsLoaded = false;
                    this.showToast('info', 'Loading Files...', 'Reading file headers and counting rows...');
                    
                    try {
                        const workDirParam = this.workingDirectory ? `&working_directory=${encodeURIComponent(this.workingDirectory)}` : '';
                        const response = await fetch(`/api/preview-columns?file_a=${encodeURIComponent(this.fileA)}&file_b=${encodeURIComponent(this.fileB)}${workDirParam}`);
                        const data = await response.json();
                        
                        this.columnsLoading = false;
                        
                        if (data.error) {
                            this.showToast('error', 'Preview Error', data.error);
                            this.columnsLoaded = false;
                            return;
                        }
                        
                        this.columns = data.columns;
                        this.fileInfo = {
                            rowsA: data.file_a_rows,
                            rowsB: data.file_b_rows
                        };
                        this.columnsLoaded = true;
                        
                        // Show success with file size info
                        let message = `Found ${data.column_count} columns | ${data.file_a_rows.toLocaleString()} & ${data.file_b_rows.toLocaleString()} rows`;
                        if (data.file_a_size_mb) {
                            message += ` | ${data.file_a_size_mb}MB & ${data.file_b_size_mb}MB`;
                        }
                        this.showToast('success', 'Files Loaded', message);
                        
                        // Show row limit suggestion if files are large
                        if (this.maxRows === 0 && data.file_a_rows > 100000) {
                            setTimeout(() => {
                                this.showToast('info', 'Row Limit Tip', 
                                    `üí° Consider using Row Limit (e.g., 50000) for faster testing on large files`);
                            }, 1500);
                        }
                        
                        // Show performance warnings if any
                        if (data.warnings && data.warnings.length > 0) {
                            setTimeout(() => {
                                data.warnings.forEach(warning => {
                                    this.showToast('warning', 'Performance Notice', warning);
                                });
                                if (data.estimated_time) {
                                    this.showToast('info', 'Estimated Time', `Expected processing time: ${data.estimated_time}`);
                                }
                            }, 2000);
                        }
                        
                    } catch (error) {
                        this.columnsLoading = false;
                        this.showToast('error', 'Network Error', error.message);
                        this.columnsLoaded = false;
                    }
                },
                
                addColumnToActiveBuilder(col) {
                    if (this.activeBuilder === 'include') {
                        if (!this.includeBuilder.includes(col)) {
                            this.includeBuilder.push(col);
                        }
                    } else {
                        if (!this.excludeBuilder.includes(col)) {
                            this.excludeBuilder.push(col);
                        }
                    }
                },
                
                selectAllColumns() {
                    if (this.columns.length === 0) {
                        this.showToast('warning', 'No Columns', 'Please load files first');
                        return;
                    }
                    
                    if (this.activeBuilder === 'include') {
                        this.includeBuilder = [...this.columns];
                    } else {
                        this.excludeBuilder = [...this.columns];
                    }
                    this.showToast('info', 'All Selected', `Added all ${this.columns.length} columns`);
                },
                
                deselectAllColumns() {
                    if (this.activeBuilder === 'include') {
                        this.includeBuilder = [];
                    } else {
                        this.excludeBuilder = [];
                    }
                },
                
                addIncludeCombination() {
                    if (this.includeBuilder.length === 0) {
                        this.showToast('warning', 'No Columns Selected', 'Please add columns to the builder first!');
                        return;
                    }
                    
                    const combo = this.includeBuilder.join(',');
                    if (!this.includedCombinations.includes(combo)) {
                        this.includedCombinations.push(combo);
                        this.showToast('success', 'Combination Added', `Added: ${combo}`);
                    }
                    this.includeBuilder = [];
                },
                
                addExcludeCombination() {
                    if (this.excludeBuilder.length === 0) {
                        this.showToast('warning', 'No Columns Selected', 'Please add columns to the builder first!');
                        return;
                    }
                    
                    const combo = this.excludeBuilder.join(',');
                    if (!this.excludedCombinations.includes(combo)) {
                        this.excludedCombinations.push(combo);
                        this.showToast('success', 'Combination Added', `Excluded: ${combo}`);
                    }
                    this.excludeBuilder = [];
                },
                
                clearInclude() {
                    this.includeBuilder = [];
                    this.includedCombinations = [];
                    this.showToast('info', 'Cleared', 'INCLUDE list cleared');
                },
                
                clearExclude() {
                    this.excludeBuilder = [];
                    this.excludedCombinations = [];
                    this.showToast('info', 'Cleared', 'EXCLUDE list cleared');
                },
                
                resetAll() {
                    this.includeBuilder = [];
                    this.excludeBuilder = [];
                    this.includedCombinations = [];
                    this.excludedCombinations = [];
                    this.showToast('info', 'Reset Complete', 'All combinations cleared');
                },
                
                async cloneRun(runId) {
                    try {
                        this.showToast('info', 'Cloning Run...', `Loading settings from Run #${runId}`);
                        
                        const response = await fetch(`/api/clone/${runId}`);
                        const data = await response.json();
                        
                        if (data.error) {
                            this.showToast('error', 'Clone Failed', data.error);
                            return;
                        }
                        
                        // Populate form fields
                        this.fileA = data.file_a;
                        this.fileB = data.file_b;
                        this.numColumns = data.num_columns;
                        this.maxRows = data.max_rows || 0;
                        this.dataQualityCheck = data.data_quality_check || false;
                        
                        // Parse and populate combinations
                        if (data.expected_combinations) {
                            this.includedCombinations = data.expected_combinations.split('\n').filter(line => line.trim());
                        } else {
                            this.includedCombinations = [];
                        }
                        
                        if (data.excluded_combinations) {
                            this.excludedCombinations = data.excluded_combinations.split('\n').filter(line => line.trim());
                        } else {
                            this.excludedCombinations = [];
                        }
                        
                        // Trigger column preview
                        await this.previewColumns();
                        
                        // Success message
                        this.showToast('success', 'Settings Cloned!', 
                            `Run #${runId} settings loaded. Modify and re-analyze!`);
                        
                        // Scroll to top smoothly
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                        // Reset dropdown
                        document.querySelectorAll('select').forEach(sel => sel.value = '');
                        
                    } catch (error) {
                        this.showToast('error', 'Network Error', error.message);
                    }
                },
                
                async submitAnalysis() {
                    this.loading = true;
                    this.animateProgressSteps();
                    
                    const formData = new FormData();
                    formData.append('file_a', this.fileA);
                    formData.append('file_b', this.fileB);
                    formData.append('num_columns', this.numColumns);
                    formData.append('max_rows', this.maxRows || 0);  // 0 = auto
                    formData.append('expected_combinations', this.includedCombinations.join('\n'));
                    formData.append('excluded_combinations', this.excludedCombinations.join('\n'));
                    formData.append('working_directory', this.workingDirectory || '');
                    formData.append('data_quality_check', this.dataQualityCheck);
                    
                    try {
                        const response = await fetch('/compare', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.run_id) {
                            this.showToast('success', 'Analysis Started', 'Redirecting to workflow page...');
                            setTimeout(() => {
                                window.location.href = `/workflow/${data.run_id}`;
                            }, 1000);
                        } else if (data.error) {
                            this.showToast('error', 'Analysis Error', data.error);
                            this.loading = false;
                        } else {
                            this.showToast('error', 'Unexpected Error', 'Please check the console for details');
                            this.loading = false;
                        }
                    } catch (error) {
                        this.showToast('error', 'Network Error', error.message);
                        this.loading = false;
                    }
                },
                
                animateProgressSteps() {
                    const delays = [100, 800, 1500, 2500, 3500];
                    this.progressSteps.forEach((step, index) => {
                        setTimeout(() => {
                            step.status = 'active';
                            if (index > 0) {
                                this.progressSteps[index - 1].status = 'completed';
                            }
                        }, delays[index]);
                    });
                },
                
                showToast(type, title, message) {
                    this.toast = { show: true, type, title, message };
                    setTimeout(() => {
                        this.toast.show = false;
                    }, 5000);
                }
            }
        }
    </script>
</body>
</html>

